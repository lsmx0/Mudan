// pages/imageUpload/imageUpload.js
Page({
  data: {
    // 用于显示选中的图片
    imagePath: '',
    // API相关配置
    API_URL: "https://s3w7y0ubldwaq3l4.aistudio-hub.baidu.com/image-classification",
    TOKEN: "b7078d51afb0279f11bfb017e00b9b6f036e0dcd"
  },

  // 选择图片事件处理函数
  chooseImage: function() {
    const that = this;
    wx.chooseMedia({
      count: 1, // 默认9
      sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
      sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
      success: function (res) {
        console.log('选择图片成功，返回结果：', res);
        console.log(Array.isArray(res.tempFilePaths));
        console.log(res.tempFilePaths);
        // 检查tempFilePaths是否存在并且是一个数组
        if (res && Array.isArray(res.tempFilePaths) && res.tempFilePaths.length > 0) {
          // 返回选定照片的本地文件路径列表，tempFilePath可以作为img标签的src属性显示图片
          that.setData({
            imagePath: res.tempFilePaths[0]
          });
          // 上传图片到服务器
          that.uploadImage(res.tempFilePaths[0]);
        } else {
          // 处理错误情况，例如提示用户重新选择图片
          console.error('未选择图片或选择失败');
          wx.showToast({
            title: '请选择图片',
            icon: 'none'
          });
        }
      },
      fail: function (err) {
        // 处理选择失败的情况
        console.error('选择图片失败:', err);
        wx.showToast({
          title: '选择图片失败',
          icon: 'none'
        });
      }
    })
  },

  // 上传图片到服务器
  uploadImage: function(imageFilePath) {
    const that = this;
    // 读取图片文件并进行Base64编码
    wx.getFileSystemManager().readFile({
      filePath: imageFilePath,
      encoding: 'base64',
      success: res => {
        const imageBase64 = res.data;
        // 设置请求头部
        const headers = {
          "Authorization": `Bearer ${that.data.TOKEN}`,
          "Content-Type": "application/json"
        };
        // 设置请求体
        const payload = {
          "image": imageBase64
        };
        // 调用API
        wx.request({
          url: that.data.API_URL,
          method: 'POST',
          data: payload,
          header: headers,
          success: function(res) {
            // 请求成功的处理逻辑
            console.log('服务器返回:', res.data);
            // 这里可以更新页面数据，显示服务器返回的结果
          },
          fail: function(err) {
            // 请求失败的处理逻辑
            console.error('网络请求失败:', err);
          }
        });
      },
      fail: err => {
        console.error('读取图片文件失败', err);
      }
    });
  },

  // 页面加载时执行的函数
  onLoad: function(options) {
    // 页面初始化 options为页面跳转所带来的参数
  }
})
